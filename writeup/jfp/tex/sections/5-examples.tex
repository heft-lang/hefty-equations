\begin{code}[hide]%
\>[0]\AgdaSymbol{\{-\#}\AgdaSpace{}%
\AgdaKeyword{OPTIONS}\AgdaSpace{}%
\AgdaPragma{--overlapping-instances}\AgdaSpace{}%
\AgdaPragma{--instance-search-depth=10}\AgdaSpace{}%
\AgdaSymbol{\#-\}}\<%
\\
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{tex.sections.5-examples}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{tex.sections.2-algebraic-effects}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{tex.sections.3-hefty-algebras}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPrimitive{force}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚Ü£\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚ü∂\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Empty}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Unit}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Bool}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{T}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Sum}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Product}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Maybe}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Maybe}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{just}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{nothing}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{maybe}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{List}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚à∑\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}++\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaFunction{head}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List.Membership.Propositional}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.String}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaPostulate{String}\AgdaSymbol{)}\<%
\\
\>[0]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Relation.Binary.PropositionalEquality}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaInductiveConstructor{[\AgdaUnderscore{}]}}\AgdaSymbol{)}\<%
\\
\>[0]\<%
\end{code}

\section{Examples}
\label{sec:examples}

As discussed in \cref{sec:higher-order-effects}, there is a wide range of examples of higher-order effects that cannot be defined as algebraic operations directly, and are typically defined as non-modular elaborations instead.
In this section we give examples of such effects and show to define them modularly using hefty algebras.
The artifact~\citep{artifact} contains the full examples.


\subsection{$\lambda$ as a Higher-Order Operation}
\label{sec:higher-order-lambda}

\begin{code}[hide]%
\>[0]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{AbstractionModule}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Alg·¥¥}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaOperator{\AgdaModule{‚ü®\AgdaUnderscore{}!\AgdaUnderscore{}‚áí\AgdaUnderscore{}‚áí\AgdaUnderscore{}!\AgdaUnderscore{}‚ü©}}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Effect}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Effect·¥¥}\<%
\\
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\end{code}

As recently observed by \citet{BergSPW21}, the (higher-order) operations for $\lambda$ abstraction and application are neither algebraic nor scoped effects.
We demonstrate how hefty algebras allow us to modularly define and elaborate an interface of higher-order operations for $\lambda$ abstraction and application, inspired by Levy's call-by-push-value~\citep{Levy06}.
The interface we will consider is parametric in a universe of types given by the following record:

\begin{code}%
%
\>[2]\AgdaKeyword{record}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set‚ÇÅ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{field}%
\>[11]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaField{u}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}%
\>[18]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[11]\AgdaOperator{\AgdaField{\AgdaUnderscore{}‚Ü£\AgdaUnderscore{}}}%
\>[18]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaField{Type}\<%
\\
%
\>[11]\AgdaField{c}%
\>[18]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaField{Type}\<%
\end{code}
%
The \aF{\_‚Ü£\_} field represents a function type, whereas \aF{c} is the type of \emph{thunk values}.
Distinguishing thunks in this way allows us to assign either a call-by-value or call-by-name semantics to the interface for $\lambda$ abstraction, given by the higher-order effect signature in \cref{fig:ho-lam-sig}, and summarized by the following smart constructors:
%
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{LamModule}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.List.Relation.Unary.All}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaComment{--\ Read\ :\ Set\ ‚Üí\ Effect}\<%
\\
%
\>[4]\AgdaComment{--\ Op\ \ (Read\ A)\ \ \ \ \ \ =\ ReadOp}\<%
\\
%
\>[4]\AgdaComment{--\ Ret\ (Read\ A)\ ask\ \ =\ A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaComment{--\ ‚Äµask\ :\ ‚¶É\ Œî\ ‚àº\ Read\ A\ ‚ñ∏\ Œî‚Ä≤\ ‚¶Ñ\ ‚Üí\ Free\ Œî\ A}\<%
\\
%
\>[4]\AgdaComment{--\ ‚Äµask\ ‚¶É\ w\ ‚¶Ñ\ =\ impure\ (inj‚ñ∏‚Çó\ ask)\ (pure\ ‚àò\ proj-ret‚ñ∏‚Çó\ ‚¶É\ w\ ‚¶Ñ)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaComment{--\ hRead\ :\ ParameterizedHandler\ (Read\ A)\ A\ id}\<%
\\
%
\>[4]\AgdaComment{--\ ret\ hRead\ x\ \AgdaUnderscore{}\ \ \ \ \ \ =\ x}\<%
\\
%
\>[4]\AgdaComment{--\ hdl\ hRead\ ask\ k\ r\ \ =\ k\ r\ r}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LamOp}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[47]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp}\<%
\\
%
\>[6]\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[28]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[48]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp}\<%
\\
%
\>[6]\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[28]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[48]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect·¥¥}\<%
\\
%
\>[4]\AgdaField{Op·¥¥}%
\>[11]\AgdaFunction{Lam}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{LamOp}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚ä•}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{\{}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{\{}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam}%
\>[16]\AgdaSymbol{\{}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[37]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
%
\begin{code}%
\>[4][@{}l@{\AgdaIndent{1}}]%
\>[6]\AgdaFunction{‚Äµlam}%
\>[12]\AgdaSymbol{:}%
\>[15]\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[31]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaBound{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}%
\>[69]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaBound{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaFunction{‚Äµvar}%
\>[12]\AgdaSymbol{:}%
\>[15]\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[31]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[69]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaBound{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaFunction{‚Äµapp}%
\>[12]\AgdaSymbol{:}%
\>[15]\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[31]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaBound{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[69]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaBound{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaFunction{‚Äµlam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{))}\<%
\\
%
\>[6]\AgdaFunction{‚Äµvar}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaSymbol{()))}\<%
\\
%
\>[6]\AgdaFunction{‚Äµapp}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))}\<%
\end{code}
%
Here \af{‚Äµlam} is a higher-order operation with a function typed computation parameter and whose return type is a function value (\aF{‚ü¶~c}~\ab{t‚ÇÅ}~\aF{‚Ü£}~\ab{t‚ÇÇ}~\aF{‚üß·µÄ}).
The \af{‚Äµvar} operation accepts a thunk value as argument and yields a value of a matching type.
The \af{‚Äµapp} operation is also a higher-order operation: its first parameter is a function value type, whereas its second parameter is a computation parameter whose return type matches that of the function value parameter type.

\begin{figure}[t]
\begin{code}%
%
\>[4]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LamOp‚Öã}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{lam}%
\>[11]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[48]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp‚Öã}\<%
\\
%
\>[6]\AgdaInductiveConstructor{var}%
\>[11]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[29]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[49]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp‚Öã}\<%
\\
%
\>[6]\AgdaInductiveConstructor{app}%
\>[11]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[29]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[49]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamOp‚Öã}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{Lam‚Öã}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect·¥¥}\<%
\\
%
\>[4]\AgdaField{Op·¥¥}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{LamOp‚Öã}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret·¥¥}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚ä•}\<%
\\
%
\>[4]\AgdaField{Fork}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{\{}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{\{}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{()}\<%
\\
%
\>[4]\AgdaField{Ty}%
\>[11]\AgdaFunction{Lam‚Öã}%
\>[17]\AgdaSymbol{\{}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÇ}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}%
\>[38]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
\caption{Higher-order effect signature of $\lambda$ abstraction and application}
\label{fig:ho-lam-sig}
\end{figure}

The interface above defines a kind of \emph{higher-order abstract syntax}~\citep{PfenningE88} which piggy-backs on Agda functions for name binding.
However, unlike most Agda functions, the constructors above represent functions with side-effects.
The representation in principle supports functions with arbitrary side-effects since it is parametric in what  the higher-order effect signature \ab{H} is.
Furthermore, we can assign different operational interpretations to the operations in the interface without having to change the interface or programs written against the interface.
To illustrate we give two different implementations of the interface: one that implements a call-by-value evaluation strategy, and one that implements call-by-name.


\subsubsection{Call-by-Value}

We give a call-by-value interpretation of \af{‚Äµlam} by generically elaborating to algebraic effect trees with any set of effects \ab{Œî}.
Our interpretation is parametric in proof witnesses that the following isomorphisms hold for value types (\ad{‚Üî} is the type of isomorphisms from the Agda standard library):
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}%
\>[395I]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{l}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[.][@{}l@{}]\<[395I]%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso‚ÇÅ}%
\>[401I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[401I]%
\>[20]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso‚ÇÇ}%
\>[423I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[423I]%
\>[20]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[41]\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>=\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\<%
\\
%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{postulate}\<%
\end{code}
\begin{code}%
\>[6][@{}l@{\AgdaIndent{1}}]%
\>[8]\AgdaPostulate{iso‚ÇÅ‚Öã}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[33]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}%
\>[46]\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[51]\AgdaOperator{\AgdaFunction{‚Üî}}%
\>[55]\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaPostulate{iso‚ÇÇ‚Öã}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[33]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}%
\>[46]\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[51]\AgdaOperator{\AgdaFunction{‚Üî}}%
\>[55]\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
%
The first isomorphism says that a function value type corresponds to a function which accepts a value of type \ab{t‚ÇÅ} and produces a computation whose return type matches that of the function type.
The second says that thunk types coincide with value types.
Using these isomorphisms, the following defines a call-by-value elaboration of functions:
%
\begin{code}%
%
\>[6]\AgdaFunction{eLamCBV}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBV}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBV}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{to}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBV}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\\
%
\>[8]\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaField{to}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaBound{a}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{v}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaComment{--\ instance}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ eLamCBV‚Ä≤\ :\ Elaboration\ Lam\ Œî}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ elaborate\ eLamCBV‚Ä≤\ =\ eLamCBV}\<%
\end{code}
%
The \ac{lam} case passes the function body given by the sub-tree \ab{œà} as a value to the continuation, where the \aF{from} function mediates the sub-tree of type \aF{‚ü¶~c}~\ab{t‚ÇÅ}~\aF{‚üß·µÄ}~\as{‚Üí}~\ad{Free}~\ab{Œî}~\aF{‚ü¶}~\ab{t‚ÇÇ}~\aF{‚üß·µÄ} to a value type \aF{‚ü¶}~\as{(}\aF{c}~\ab{t‚ÇÅ}\as{)}~\aF{‚Ü£}~\ab{t‚ÇÇ}~\aF{‚üß·µÄ}, using the isomorphism \af{iso‚ÇÅ}.
The \ac{var} case uses the \aF{to} function to mediate a \aF{‚ü¶~c}~\ab{t}~\aF{‚üß·µÄ} value to a \aF{‚ü¶}~\ab{t}~\aF{‚üß·µÄ} value, using the isomorphism \af{iso‚ÇÇ}.
The \ac{app} case first eagerly evaluates the argument expression of the application (in the sub-tree \ab{œà}) to an argument value, and then passes the resulting value to the function value of the application.
The resulting value is passed to the continuation.

Using the elaboration above, we can evaluate programs such as the following which uses both the higher-order lambda effect, the algebraic state effect, and assumes that our universe has a number type \aF{‚ü¶}~\ab{num}~\aF{‚üß·µÄ}~\ad{‚Üî}~\ad{‚Ñï}:
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{4}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}%
\>[518I]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[518I]%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{num}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>=\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\<%
\\
%
\>[8]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\end{code}
\begin{code}%
%
\>[6]\AgdaFunction{ex}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[6]\AgdaFunction{ex}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaNumber{1}\<%
\\
%
\>[8]\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}%
\>[586I]\AgdaFunction{‚Äµlam}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[586I][@{}l@{\AgdaIndent{0}}]%
\>[14]\AgdaBound{n‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaFunction{‚Äµvar}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[14]\AgdaBound{n‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaFunction{‚Äµvar}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[14]\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaField{to}\AgdaSpace{}%
\AgdaBound{n‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{to}\AgdaSpace{}%
\AgdaBound{n‚ÇÇ}\AgdaSymbol{))))}\<%
\\
%
\>[8]\AgdaBound{v}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaFunction{‚Äµapp}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaFunction{incr}\<%
\\
%
\>[8]\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{to}\AgdaSpace{}%
\AgdaBound{v}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaFunction{incr}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\AgdaSpace{}%
\AgdaBound{s‚ÇÄ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{get}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{s‚ÇÄ}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{+}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{);}\AgdaSpace{}%
\AgdaBound{s‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{get}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaBound{s‚ÇÅ}\AgdaSymbol{)}\<%
\end{code}
The program first sets the state to \an{1}.
Then it constructs a function that binds a variable \ab{x}, dereferences the variable twice, and adds the two resulting values together.
Finally, the application in the second-to-last line applies the function with an argument expression which increments the state by \an{1} and returns the resulting value.
Running the program produces \an{4} since the state increment expression is eagerly evaluated before the function is applied.
%
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{CBVExample}\AgdaSpace{}%
\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{private}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function.Construct.Identity}%
\>[49]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{‚Üî-id}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\<%
\\
%
\>[6]\AgdaComment{--\ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚ü∂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\>[8]\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{CBVUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[8]\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü∂}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}%
\>[35]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{num}%
\>[35]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-num}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-fun}%
\>[695I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[695I]%
\>[16]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü∂}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-fun}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-c}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaFunction{id}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-c}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{LamCBVUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\<%
\\
%
\>[8]\AgdaField{u}%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{CBVUniv}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{\AgdaUnderscore{}‚Ü£\AgdaUnderscore{}}}%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚ü∂\AgdaUnderscore{}}}\<%
\\
%
\>[8]\AgdaField{c}%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBVUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{id}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\end{code}
\begin{code}%
%
\>[8]\AgdaFunction{elab-cbv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{elab-cbv}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{eLamCBV}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eNil}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{test-ex-cbv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hSt}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{elaborate}\AgdaSpace{}%
\AgdaFunction{elab-cbv}\AgdaSpace{}%
\AgdaFunction{ex}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{4}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{test-ex-cbv}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}

\subsubsection{Call-by-Name}

The key difference between the call-by-value and the call-by-name interpretation of our $\lambda$ operations is that we now assume that thunks are computations.
That is, we assume that the following isomorphisms hold for value types:
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}%
\>[823I]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[.][@{}l@{}]\<[823I]%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso‚ÇÅ}%
\>[829I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[829I]%
\>[20]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}%
\>[65]\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso‚ÇÇ}%
\>[850I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[850I]%
\>[20]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{postulate}\<%
\end{code}
\begin{code}%
\>[6][@{}l@{\AgdaIndent{1}}]%
\>[8]\AgdaPostulate{iso‚ÇÅ‚Öã}%
\>[15]\AgdaSymbol{:}%
\>[18]\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[34]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚Ü£}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[50]\AgdaOperator{\AgdaFunction{‚Üî}}%
\>[53]\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaPostulate{iso‚ÇÇ‚Öã}%
\>[15]\AgdaSymbol{:}%
\>[18]\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[34]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaField{c}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[50]\AgdaOperator{\AgdaFunction{‚Üî}}%
\>[53]\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
Using these isomorphisms, the following defines a call-by-name elaboration of functions:
\begin{code}%
%
\>[6]\AgdaFunction{eLamCBN}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBN}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{lam}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBN}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{var}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{to}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
%
\>[6]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eLamCBN}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{app}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}%
\>[32]\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{to}\AgdaSpace{}%
\AgdaBound{f}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaComment{--\ instance}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ eLamCBN‚Ä≤\ :\ Elaboration\ Lam\ Œî}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ elaborate\ eLamCBN‚Ä≤\ =\ eLamCBN}\<%
\end{code}
%
The case for \ac{lam} is the same as the call-by-value elaboration.
The case for \ac{var} now needs to force the thunk by running the computation and passing its result to \ab{k}.
The case for \ac{app} passes the argument sub-tree (\ab{œà}) as an argument to the function \ab{f}, runs the computation resulting from doing so, and then passes its result to \ab{k}.
%
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{4}}]%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{CBNExample}\AgdaSpace{}%
\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{private}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function.Construct.Identity}%
\>[49]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{‚Üî-id}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[6]\AgdaComment{--\ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚ü∂\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSymbol{)}%
\>[34]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\>[8]\AgdaInductiveConstructor{num}%
\>[13]\AgdaSymbol{:}%
\>[35]\AgdaDatatype{LamType}\<%
\\
%
\>[8]\AgdaInductiveConstructor{susp}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}%
\>[36]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{CBNUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[8]\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{LamType}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü∂}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSymbol{)}%
\>[35]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{num}%
\>[36]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{susp}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}%
\>[36]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-num}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-fun}%
\>[1024I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{LamType}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1024I]%
\>[16]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚ü∂}}\AgdaSpace{}%
\AgdaBound{t‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-fun}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-susp}%
\>[1049I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[1049I]%
\>[17]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaInductiveConstructor{susp}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-susp}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{LamCBNUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{LamUniv}\<%
\\
%
\>[8]\AgdaField{u}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{CBNUniv}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{\AgdaUnderscore{}‚Ü£\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{\AgdaUnderscore{}‚ü∂\AgdaUnderscore{}}}\<%
\\
%
\>[8]\AgdaField{c}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{LamCBNUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{susp}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\AgdaSpace{}%
\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\end{code}
%
Running the example program \af{ex} from above now produces \an{5} as result, since the state increment expression in the argument of \af{‚Äµapp} is thunked and run twice during the evaluation of the called function.
%
\begin{code}%
%
\>[8]\AgdaFunction{elab-cbn}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lam}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{elab-cbn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{eLamCBN}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eNil}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{test-ex-cbn}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hSt}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{elaborate}\AgdaSpace{}%
\AgdaFunction{elab-cbn}\AgdaSpace{}%
\AgdaFunction{ex}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{5}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaNumber{3}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{test-ex-cbn}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}


\subsection{Optionally Transactional Exception Catching}
\label{sec:optionally-transactional}

A feature of scoped effect handlers~\citep{WuSH14,PirogSWJ18,YangPWBS22} is that changing the order of handlers makes it possible to obtain different semantics of \emph{effect interaction}.
A classical example of effect interaction is the interaction between state and exception catching that we briefly considered at the end of \cref{sec:hefty-algebras} in connection with this \ad{transact} program:
%
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{6}}]%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{CCModule}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Abbreviation}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Alg·¥¥}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{‚Äµthrow·¥¥}%
\>[1147I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[1147I][@{}l@{\AgdaIndent{0}}]%
\>[13]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\\
%
\>[4]\AgdaFunction{‚Äµthrow·¥¥}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{throw}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{‚ä•-elim}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{unit}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{unit}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\end{code}    
\begin{code}%
%
\>[6]\AgdaFunction{transact‚Öã}%
\>[1194I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚Çõ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚Çú}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}%
\>[73]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[.][@{}l@{}]\<[1194I]%
\>[16]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[6]\AgdaFunction{transact‚Öã}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaNumber{1}\<%
\\
%
\>[8]\AgdaFunction{‚Äµcatch}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaKeyword{do}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{throw}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{‚ä•-elim}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaFunction{tt‚Öã}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{get}\<%
\end{code}
\begin{code}[hide]%
\>[6][@{}l@{\AgdaIndent{1}}]%
\>[7]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaFunction{tt‚Öã}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaField{from}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\<%
\end{code}
%
% The program first sets the state to \an{1}; then runs the ``try'' block of the \af{‚Äµcatch} operation, which sets the state to \an{2} and subsequently throws an exception.
% This causes the ``catch'' block of the \af{‚Äµcatch} operation to run, which does nothing.
% The last line of the program inspects the final state of the program.
% %
The state and exception catching effect can interact to give either of these two semantics:
\begin{enumerate}
\item \emph{Global} interpretation of state, where the \af{transact} program returns \an{2} since the \ac{put} operation in the ``try'' block causes the state to be updated globally.
\item \emph{Transactional} interpretation of state, where the \af{transact} program returns \an{1} since the state changes of the \ac{put} operation are \emph{rolled back} when the ``try'' block throws an exception.
\end{enumerate}
%
With monad transformers~\citep{cenciarelli1993syntactic,Liang1995monad} we can recover either of these semantics by permuting the order of monad transformers.
With scoped effect handlers we can also recover either by permuting the order of handlers.
However, the \ad{eCatch} elaboration in \cref{sec:hefty-algebras} always gives us a global interpretation of state.
In this section we demonstrate how we can recover a transactional interpretation of state by using a different elaboration of the \ac{catch} operation into an algebraically effectful program with the \ac{throw} operation and the off-the-shelf \emph{sub/jump} control effects due to \citet{thielecke1997phd,DBLP:conf/csl/FioreS14}.
The different elaboration is modular in the sense that we do not have to change the interface of the catch operation nor any programs written against the interface.

\subsubsection{Sub/Jump}
We recall how to define two operations, sub and jump, due to~\citet{thielecke1997phd,DBLP:conf/csl/FioreS14}.
We define these operations as algebraic effects following~\citet{SchrijversPWJ19}.
The algebraic effect signature of \ad{CC}~\ab{Ref} is given in \cref{fig:alg-eff-ccop}, and is summarized by the following smart constructors:
%
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{CCOp}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{sub}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[51]\AgdaSymbol{‚Üí}%
\>[54]\AgdaDatatype{CCOp}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\>[6]\AgdaInductiveConstructor{jump}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}%
\>[55]\AgdaDatatype{CCOp}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect}\<%
\\
%
\>[4]\AgdaField{Op}%
\>[8]\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{CCOp}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\})}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚äé}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{jump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚ä•}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\begin{code}%
\>[4][@{}l@{\AgdaIndent{1}}]%
\>[6]\AgdaFunction{‚Äµsub}%
\>[13]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}%
\>[82]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\\
%
\>[6]\AgdaFunction{‚Äµjump}%
\>[13]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}%
\>[84]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaGeneralizable{B}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaFunction{‚Äµsub}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaSymbol{(}\AgdaFunction{inj}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{[}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{]}}\AgdaSymbol{))}\<%
\\
%
\>[6]\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaSymbol{(}\AgdaFunction{inj}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{jump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaSymbol{()))}\<%
\end{code}
%
An operation \af{‚Äµsub}~\ab{f}~\ab{g} gives a computation \ab{f} access to the continuation \ab{g} via a reference value \ab{Ref}~\ab{t} which represents a continuation expecting a value of type \aF{‚ü¶}~\ab{t}~\aF{‚üß·µÄ}.
The \af{‚Äµjump} operation invokes such continuations.

\begin{figure}[t]
\begin{code}%
%
\>[4]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{CCOp‚Öã}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{sub}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}%
\>[51]\AgdaSymbol{‚Üí}%
\>[54]\AgdaDatatype{CCOp‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\>[6]\AgdaInductiveConstructor{jump}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}%
\>[55]\AgdaDatatype{CCOp‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaFunction{CC‚Öã}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect}\<%
\\
%
\>[4]\AgdaField{Op}%
\>[8]\AgdaSymbol{(}\AgdaFunction{CC‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{CCOp‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\})}%
\>[32]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚äé}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC‚Öã}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{jump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}%
\>[32]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚ä•}\<%
\end{code}
\caption{Effect signature of the sub/jump effect}
\label{fig:alg-eff-ccop}
\end{figure}


The operations and their handler (abbreviated to \af{h}) satisfy the following laws:
\begin{align*}
  \af{h}~\as{(}\af{‚Äµsub}~\as{(Œª~\_~‚Üí}~\ab{p}\as{)}~\ab{k}\as{)}
  &~\ad{‚â°}~\af{h}~\ab{p}
  \\
  \af{h}~\as{(}\af{‚Äµsub}~\as{(Œª}~\ab{r}~\as{‚Üí}~\ab{m}~\af{ùìë}~\af{‚Äµjump}~\ab{r}\as{)}~\ab{k}\as{)}
   &~\ad{‚â°}~\af{h}~\as{(}\ab{m}~\af{ùìë}~\ab{k}\as{)}
  \\
  \af{h}~\as{(}\af{‚Äµsub}~\ab{p}~\as{(}\af{‚Äµjump}~\ab{r‚Ä≤}\as{))}
  &~\ad{‚â°}~\af{h}~\as{(}\ab{p}~\ab{r‚Ä≤}\as{)}
  \\
  \af{h}~\as{(}\af{‚Äµsub}~\ab{p}~\ab{q}~\af{ùìë}~\ab{k}\as{)}
 &~\ad{‚â°}~\af{h}~\as{(}\af{‚Äµsub}~\as{(Œª}~\ab{x}~\as{‚Üí}~\ab{p}~\ab{x}~\af{ùìë}~\ab{k}~\as{)}~\as{(Œª}~\ab{x}~\as{‚Üí}~\ab{q}~\ab{x}~\af{ùìë}~\ab{k}\as{))}
\end{align*}
The last law asserts that \af{‚Äµsub} and \af{‚Äµjump} are \emph{algebraic} operations, since their computational sub-terms behave as continuations.
Thus, we encode \af{‚Äµsub} and its handler as an algebraic effect.
%
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
\begin{code}[hide]%
\>[4][@{}l@{\AgdaIndent{1}}]%
\>[6]\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚ü®}}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{!}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî‚Ä≤}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚áí}}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚áí}}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{!}}\AgdaSpace{}%
\AgdaGeneralizable{Œî‚Ä≤}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚ü©}}\<%
\\
%
\>[6]\AgdaField{ret}%
\>[11]\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaBound{a}\<%
\\
%
\>[6]\AgdaField{hdl}%
\>[11]\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{sub}%
\>[24]\AgdaOperator{\AgdaInductiveConstructor{,}}%
\>[29]\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{c}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{flip}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àò}}\AgdaSpace{}%
\AgdaInductiveConstructor{inj‚ÇÇ}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{in}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{c}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\<%
\\
%
\>[6]\AgdaField{hdl}%
\>[11]\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{jump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\<%
\end{code}
%
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{private}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}‚Ñï+\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Effect.Monad}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{NumType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{NumType}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{NumUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[8]\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{NumUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}%
\>[30]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{NumType}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}%
\>[14]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{NumUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{num}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Effect}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{NumType}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\<%
\\
%
\>[6]\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{ex‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[6]\AgdaFunction{ex‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{‚Äµsub}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaNumber{41}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{‚Ñï+}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{test‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaFunction{ex‚ÇÄ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaNumber{42}\<%
\\
%
\>[6]\AgdaFunction{test‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{ex‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Cont}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[6]\AgdaFunction{ex‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{‚Äµsub}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaNumber{41}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{‚Ñï+}}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{test‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hCC}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaFunction{ex‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaNumber{41}\<%
\\
%
\>[6]\AgdaFunction{test‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}


\subsubsection{Optionally Transactional Exception Catching}
\label{sec:optional-transactional}

By using the \af{‚Äµsub} and \af{‚Äµjump} operations in our elaboration of \ad{catch}, we get a semantics of exception catching whose interaction with state depends on the order that the state effect and sub/jump effect is handled.
%
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{TransactionalCatch}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{CCModule}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Abbreviation}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}%
\>[1657I]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[.][@{}l@{}]\<[1657I]%
\>[13]\AgdaSymbol{\{}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\<%
\\
%
\>[13]\AgdaSymbol{\{}\AgdaBound{unit}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
%
\>[13]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{unit}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[13]\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ open\ Elab}\<%
\\
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}%
\>[16]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{eCatchOT}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[8]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eCatchOT}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{catch}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{true}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{‚Äµsub}%
\>[16]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚ôØ}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hThrow}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{maybe}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)))}\<%
\\
%
\>[16]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{instance}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{‚àô-comm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{w‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{.}\AgdaField{proj‚ÇÇ}\AgdaSymbol{)}\<%
\end{code}
\begin{code}%
%
\>[8]\AgdaFunction{eCatchOT‚Öã}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaPostulate{‚â≤‚Öã}}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaPostulate{‚â≤‚Öã}}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[8]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eCatchOT‚Öã}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{catch}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{let}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{true}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSpace{}%
\AgdaKeyword{in}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{‚Äµsub}%
\>[16]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚ôØ}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hThrow}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{maybe}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaBound{r}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{from}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)))}\<%
\\
%
\>[16]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\<%
\end{code}
\begin{code}[hide]%
%
\>[10]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{instance}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{‚àô-comm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{w‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{.}\AgdaField{proj‚ÇÇ}\AgdaSymbol{)}\<%
\end{code}
%
The elaboration uses \af{‚Äµsub} to capture the continuation of a higher-order \ac{catch} operation.
If no exception is raised, then control flows to the continuation \ab{k} without invoking the continuation of \af{‚Äµsub}.
Otherwise, we jump to the continuation of \af{‚Äµsub}, which runs \ab{m‚ÇÇ} before passing control to \ab{k}.
Capturing the continuation in this way interacts with state because the continuation of \af{‚Äµsub} may have been pre-applied to a state handler that only knows about the ``old'' state.
This happens when we handle the state effect before the sub/jump effect: in this case we get the transactional interpretation of state, so running \af{transact} gives \an{1}.
Otherwise, if we run the sub/jump handler before the state handler, we get the global interpretation of state and the result \an{2}.
%
\begin{code}[hide]%
%
\>[6]\AgdaComment{--\ instance}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ eCatchOT‚Ä≤\ :\ Elab\ Catch\ Œî}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ orate\ eCatchOT‚Ä≤\ =\ eCatchOT}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{3}}]%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaPrimitive{\AgdaUnderscore{}+\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[0]\<%
\\
%
\>[6]\AgdaFunction{transact}%
\>[1832I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
\>[.][@{}l@{}]\<[1832I]%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚Çõ}%
\>[23]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w‚Çú}%
\>[23]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}%
\>[23]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{unit}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{iso}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{unit}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[6]\AgdaFunction{transact}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{unit}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{unit}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaNumber{1}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{‚Äµcatch}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaKeyword{do}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{put}\AgdaSpace{}%
\AgdaNumber{2}\AgdaSymbol{);}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{throw}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{‚ä•-elim}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaField{to}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{))}\<%
\\
%
\>[8]\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{get}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{CatchExample}\AgdaSpace{}%
\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{private}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Inverse}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{...}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Function.Construct.Identity}%
\>[49]\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{‚Üî-id}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaComment{--\ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{CatchType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{unit}%
\>[15]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{CatchType}\<%
\\
%
\>[8]\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{CatchType}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{CatchUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[8]\AgdaField{Type}%
\>[14]\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CatchUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{CatchType}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CatchUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{unit}%
\>[34]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{CatchUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{iso-1}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üî}}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaInductiveConstructor{unit}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{iso-1}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Üî-id}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{transact-elab‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[2029I]\AgdaFunction{Elaboration}\<%
\\
\>[2029I][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{transact-elab‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eCatchOT}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eNil}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{transact-elab‚ÇÉ}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[2160I]\AgdaFunction{Elaboration}\<%
\\
\>[2160I][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Catch}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{State}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Throw}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{transact-elab‚ÇÉ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eCatchOT}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eNil}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaComment{--\ module\ \AgdaUnderscore{}\ where}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ private\ instance}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÄ\ :\ CC\ (Œª\ t\ ‚Üí\ ‚ü¶\ t\ ‚üß·µÄ\ ‚Üí\ Free\ Nil\ A)\ ‚â≤\ (State\ ‚äï\ Throw\ ‚äï\ CC\ (Œª\ t\ ‚Üí\ ‚ü¶\ t\ ‚üß·µÄ\ ‚Üí\ Free\ Nil\ A)\ ‚äï\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÄ\ =\ ‚â≤-right\ ‚¶É\ ‚â≤-right\ ‚¶É\ ‚â≤-left\ ‚¶Ñ\ ‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÅ\ :\ State\ ‚â≤\ (State\ ‚äï\ Throw\ ‚äï\ CC\ (Œª\ t\ ‚Üí\ ‚ü¶\ t\ ‚üß·µÄ\ ‚Üí\ Free\ Nil\ A)\ ‚äï\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÅ\ =\ ‚â≤-left\ ‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÇ\ :\ Throw\ ‚â≤\ (CC\ (Œª\ t\ ‚Üí\ ‚ü¶\ t\ ‚üß·µÄ\ ‚Üí\ Free\ Nil\ A)\ ‚äï\ State\ ‚äï\ Throw\ ‚äï\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ x‚ÇÇ\ =\ ‚â≤-right\ ‚¶É\ ‚â≤-right\ ‚¶É\ ‚â≤-left\ ‚¶Ñ\ ‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÄ\ :\ Lift\ State\ ‚â≤·¥¥\ (Lift\ State\ ‚àî\ Lift\ Throw\ ‚àî\ Catch\ ‚àî\ Lift\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÄ\ =\ ‚â≤·¥¥-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÅ\ :\ Lift\ Throw\ ‚â≤·¥¥\ (Lift\ State\ ‚àî\ Lift\ Throw\ ‚àî\ Catch\ ‚àî\ Lift\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÅ\ =\ ‚â≤·¥¥-right\ ‚¶É\ ‚â≤·¥¥-left\ ‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÇ\ :\ Catch\ ‚â≤·¥¥\ (Lift\ State\ ‚àî\ Lift\ Throw\ ‚àî\ Catch\ ‚àî\ Lift\ Nil)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ y‚ÇÇ\ =\ ‚â≤·¥¥-right\ ‚¶É\ ‚â≤·¥¥-right\ ‚¶É\ ‚â≤·¥¥-left\ ‚¶Ñ\ ‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ \ \ test-transact‚ÇÇ\ :\ \ un}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (given\ hCC}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hSt}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÇ\ transact)\ \$\ 0)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ‚â°\ just\ (1\ ,\ 1)}\<%
\\
%
\>[6]\AgdaComment{--\ \ \ test-transact‚ÇÇ\ =\ refl}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ\ :\ un\ (given\ hSt}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÉ\ transact)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ 0)\ ‚â°\ (just\ 2\ ,\ 2)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ\ =\ refl}\<%
\end{code}
\begin{code}[hide]%
\>[0]\AgdaComment{--\ \ \ \ \ \ \ transact‚Ä≤\ :\ ‚¶É\ w‚Çõ\ :\ H\ ‚àº\ Lift\ State\ ‚ñπ\ H‚Ä≤\ ‚¶Ñ\ ‚¶É\ w‚Çú\ :\ H\ ‚àº\ \ Lift\ Throw\ ‚ñπ\ H‚Ä≥\ ‚¶Ñ\ ‚¶É\ w\ \ :\ H\ ‚àº\ Catch\ ‚ñπ\ H‚Ä¥\ ‚¶Ñ}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ‚Üí\ Hefty\ H\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ transact‚Ä≤\ =\ do}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚Üë\ put\ 1}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚Äµcatch\ (do\ ‚Üë\ put\ 2)\ (pure\ (from\ tt))}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚Üë\ get}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ where\ open\ HeftyModule\ using\ (\AgdaUnderscore{}>>\AgdaUnderscore{})}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÇ‚Ä≤\ :\ un\ (given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hSt}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÇ\ transact‚Ä≤)\ \$\ 0)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)\ ‚â°\ just\ (2\ ,\ 2)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÇ‚Ä≤\ =\ refl}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ‚Ä≤\ :\ un\ (given\ hSt}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÉ\ transact‚Ä≤)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ 0)\ ‚â°\ (just\ 2\ ,\ 2)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ‚Ä≤\ =\ refl}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ transact‚Ä≥\ :\ ‚¶É\ w‚Çõ\ :\ H\ ‚àº\ Lift\ State\ ‚ñπ\ H‚Ä≤\ ‚¶Ñ\ ‚¶É\ w‚Çú\ :\ H\ ‚àº\ \ Lift\ Throw\ ‚ñπ\ H‚Ä≥\ ‚¶Ñ\ ‚¶É\ w\ \ :\ H\ ‚àº\ Catch\ ‚ñπ\ H‚Ä¥\ ‚¶Ñ}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ‚Üí\ Hefty\ H\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ transact‚Ä≥\ =\ do}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚Üë\ put\ 1}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚Äµcatch\ (do\ ‚Üë\ put\ 2;\ ‚Äµthrow·¥¥)\ (‚Üë\ get)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ where\ open\ HeftyModule\ using\ (\AgdaUnderscore{}>>\AgdaUnderscore{})}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÇ‚Ä≥\ :\ un\ (given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hSt}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÇ\ transact‚Ä≥)\ \$\ 0)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)\ ‚â°\ just\ (1\ ,\ 1)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÇ‚Ä≥\ =\ refl}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ‚Ä≥\ :\ un\ (given\ hSt}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (given\ hThrow}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ transact-elab‚ÇÉ\ transact‚Ä≥)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ tt)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \$\ 0)\ ‚â°\ (just\ 2\ ,\ 2)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-transact‚ÇÉ‚Ä≥\ =\ refl}\<%
\end{code}

The sub/jump elaboration above is more involved than the scoped effect handler that we considered in \cref{sec:scoped-effects}.
However, the complicated encoding does not pollute the higher-order effect interface, and only turns up if we strictly want or need effect interaction.


\subsection{Logic Programming}

Following \citet{DBLP:conf/ppdp/SchrijversWDD14,WuSH14,YangPWBS22} we can define a non-deterministic choice operation (\af{\_‚Äµor\_}) as an algebraic effect, to provide support for expressing the kind of non-deterministic search for solutions that is common in logic programming.
We can also define a \af{‚Äµfail} operation which indicates that the search in the current branch was unsuccessful.
The effect signature for \ad{Choice} is given in \cref{fig:choice-sig}.
The following smart constructors are the lifted higher-order counterparts to the \af{‚Äµor} and \af{‚Äµfail} operations:
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{ChoiceModule}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Abbreviation}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{Alg·¥¥}\<%
\\
%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ open\ Elab}\<%
\end{code}
\begin{figure}
\begin{minipage}{0.495\linewidth}
\begin{code}%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[4]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ChoiceOp}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaInductiveConstructor{or}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChoiceOp}\<%
\\
%
\>[6]\AgdaInductiveConstructor{fail}%
\>[12]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ChoiceOp}\<%
\end{code}
  \end{minipage}
  \hfill\vline\hfill
  \begin{minipage}{0.495\linewidth}
\begin{code}%
%
\>[4]\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Effect}\<%
\\
%
\>[4]\AgdaField{Op}%
\>[8]\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{ChoiceOp}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaInductiveConstructor{or}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Bool}\<%
\\
%
\>[4]\AgdaField{Ret}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚ä•}\<%
\end{code}
\end{minipage}
\caption{Effect signature of the choice effect}
\label{fig:choice-sig}
\end{figure}
\begin{code}[hide]%
%
\>[4]\AgdaFunction{‚Äµfail}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\\
%
\>[4]\AgdaComment{--\ \AgdaUnderscore{}‚Äµor\AgdaUnderscore{}\ :\ ‚¶É\ Œî\ ‚àº\ Choice\ ‚ñ∏\ Œî‚Ä≤\ ‚¶Ñ\ ‚Üí\ Free\ Œî\ A\ ‚Üí\ Free\ Œî\ A\ ‚Üí\ Free\ Œî\ A}\<%
\end{code}
\begin{code}[hide]%
%
\>[4]\AgdaComment{--\ \AgdaUnderscore{}‚Äµor\AgdaUnderscore{}\ ‚¶É\ w\ ‚¶Ñ\ m‚ÇÅ\ m‚ÇÇ\ =\ impure\ (inj‚ñ∏‚Çó\ or)\ ((if\AgdaUnderscore{}then\ m‚ÇÅ\ else\ m‚ÇÇ)\ ‚àò\ proj-ret‚ñ∏‚Çó\ ‚¶É\ w\ ‚¶Ñ)}\<%
\\
%
\>[4]\AgdaFunction{‚Äµfail}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaSymbol{(}\AgdaFunction{inj}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaSymbol{()))}\<%
\\
%
\>[6]\AgdaComment{--\ (inj‚ñ∏‚Çó\ fail\ ,\ ‚ä•-elim\ ‚àò\ proj-ret‚ñ∏‚Çó\ ‚¶É\ w\ ‚¶Ñ)}\<%
\end{code}
\begin{code}[hide]%
%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>=\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{hChoice}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚ü®}}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{!}}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚áí}}\AgdaSpace{}%
\AgdaRecord{‚ä§}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚áí}}\AgdaSpace{}%
\AgdaDatatype{List}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{!}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚ü©}}\<%
\\
%
\>[6]\AgdaField{ret}\AgdaSpace{}%
\AgdaFunction{hChoice}\AgdaSpace{}%
\AgdaBound{a}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{a}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{‚à∑}}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaField{hdl}\AgdaSpace{}%
\AgdaFunction{hChoice}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{or}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{p}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaBound{l‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaInductiveConstructor{true}%
\>[22]\AgdaBound{p}\<%
\\
%
\>[8]\AgdaBound{l‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaInductiveConstructor{false}%
\>[22]\AgdaBound{p}\<%
\\
%
\>[8]\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{l‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{++}}\AgdaSpace{}%
\AgdaBound{l‚ÇÇ}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaField{hdl}\AgdaSpace{}%
\AgdaFunction{hChoice}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{fail}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaInductiveConstructor{[]}\<%
\end{code}
\begin{figure}
  \begin{minipage}{0.495\linewidth}
\begin{code}%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{OnceOp}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{OnceOp}\<%
\end{code}
\end{minipage}
\hfill\vline\hfill
\begin{minipage}{0.495\linewidth}
\begin{code}%
%
\>[6]\AgdaFunction{Once}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect·¥¥}\<%
\\
%
\>[6]\AgdaField{Op·¥¥}%
\>[13]\AgdaFunction{Once}%
\>[27]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{OnceOp}\<%
\\
%
\>[6]\AgdaField{Ret·¥¥}%
\>[13]\AgdaFunction{Once}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaField{Fork}%
\>[13]\AgdaFunction{Once}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[6]\AgdaField{Ty}%
\>[13]\AgdaFunction{Once}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
\end{minipage}
\caption{Higher-order effect signature of the once effect}
\label{fig:once-ho-sig}
\end{figure}
\begin{code}%
%
\>[6]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚Äµor·¥¥\AgdaUnderscore{}}}%
\>[14]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaGeneralizable{A}%
\>[62]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\\
%
\>[6]\AgdaFunction{‚Äµfail·¥¥}%
\>[14]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}%
\>[62]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\end{code}
\begin{code}[hide]%
%
\>[6]\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}‚Äµor·¥¥\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{or}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë'}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{if\AgdaUnderscore{}then}}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{else}}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSymbol{)}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë'\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{‚Äµfail·¥¥}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{fail}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë'}}\AgdaSpace{}%
\AgdaFunction{‚ä•-elim}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\AgdaSpace{}%
\AgdaKeyword{renaming}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSpace{}%
\AgdaSymbol{to}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë'\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
A useful operator for cutting non-deterministic search short when a solution is found is the \af{‚Äµonce} operator.
The \af{‚Äµonce} operator, whose higher-order effect signature is given in \cref{fig:once-ho-sig}, is not an algebraic effect, but a scoped (and thus higher-order) effect.
\begin{code}%
\>[6][@{}l@{\AgdaIndent{1}}]%
\>[7]\AgdaFunction{‚Äµonce}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Once}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
\begin{code}[hide]%
%
\>[7]\AgdaFunction{‚Äµonce}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{b}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\<%
\\
\>[7][@{}l@{\AgdaIndent{0}}]%
\>[9]\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{b}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\end{code}
We can define the meaning of the \af{once} operator as the following elaboration:
\begin{code}%
\>[6][@{}l@{\AgdaIndent{1}}]%
\>[8]\AgdaFunction{eOnce}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{Choice}\AgdaSpace{}%
\AgdaOperator{\AgdaPostulate{‚â≤‚Öã}}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Once}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[8]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eOnce}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{once}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaBound{l}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üê}}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ôØ}}\AgdaSpace{}%
\AgdaSymbol{((}\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hChoice}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{maybe}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaFunction{‚Äµfail}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{head}\AgdaSpace{}%
\AgdaBound{l}\AgdaSymbol{)}\<%
\end{code}
\begin{code}[hide]%
%
\>[10]\AgdaKeyword{where}\AgdaSpace{}%
\AgdaKeyword{instance}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{‚àô-comm}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{.}\AgdaField{proj‚ÇÇ}\AgdaSymbol{)}\<%
\end{code}
The elaboration runs the branch (\ab{œà}) of \ac{once} under the \af{hChoice} handler to compute a list of all solutions of \ab{œà}.
It then tries to choose the first solution and pass that to the continuation \ab{k}.
If the branch has no solutions, we fail.
%
Under a strict evaluation order, the elaboration computes all possible solutions which is doing more work than needed.
Agda 2.6.2.2 does not have a specified evaluation strategy, but does compile to Haskell which is lazy.
In Haskell, the solutions would be lazily computed, such that the \ac{once} operator cuts search short as intended.

\begin{code}[hide]%
\>[0]\AgdaComment{--\ \ \ \ \ module\ OnceExample\ where}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ open\ import\ Data.Nat\ using\ (‚Ñï;\ \AgdaUnderscore{}‚â°·µá\AgdaUnderscore{})}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ open\ HeftyModule\ using\ (\AgdaUnderscore{}ùìë\AgdaUnderscore{};\ \AgdaUnderscore{}>>\AgdaUnderscore{})}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ open\ ElabModule}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ private\ \AgdaUnderscore{}>>=\AgdaUnderscore{}\ =\ \AgdaUnderscore{}ùìë\AgdaUnderscore{}}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ data\ OnceType\ :\ Set\ where}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ num\ \ \ :\ OnceType}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ unit\ \ :\ OnceType}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ private\ instance}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ OnceUniv\ :\ Univ}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ Ty\ ‚¶É\ OnceUniv\ ‚¶Ñ\ =\ OnceType}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚ü¶\AgdaUnderscore{}‚üß·µÄ\ ‚¶É\ OnceUniv\ ‚¶Ñ\ num\ =\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ ‚ü¶\AgdaUnderscore{}‚üß·µÄ\ ‚¶É\ OnceUniv\ ‚¶Ñ\ unit\ =\ ‚ä§}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-0or1\ :\ Hefty\ (Lift\ Choice\ ‚àî\ Once\ ‚àî\ Lift\ Nil)\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-0or1\ =\ (pure\ 0)\ ‚Äµor·¥¥\ (pure\ 1)}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-fail-once\ :\ Hefty\ (Lift\ Choice\ ‚àî\ Once\ ‚àî\ Lift\ Nil)\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-fail-once\ =\ do}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ r\ ‚Üê\ ‚Äµonce\ ex-0or1}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ if\ r\ ‚â°·µá\ 0\ then\ ‚Äµfail·¥¥\ else\ pure\ r}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ once-elab\ :\ Elaboration\ (Lift\ Choice\ ‚àî\ Once\ ‚àî\ Lift\ Nil)\ (Choice\ ‚äï\ Nil)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ once-elab\ =\ eLift\ ‚ãé\ eOnce\ ‚ãé\ eNil}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-ex-0or1\ :\ un\ (given\ hChoice\ handle\ (elaborate\ once-elab\ ex-0or1)\ \$\ tt)\ ‚â°\ 0\ ‚à∑\ 1\ ‚à∑\ []}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-ex-0or1\ =\ refl}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-fail-once\ :\ un\ (given\ hChoice\ handle\ (elaborate\ once-elab\ ex-fail-once)\ \$\ tt)\ ‚â°\ []}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-fail-once\ =\ refl}\<%
\end{code}


\subsection{Concurrency}

Finally, we consider how to define higher-order operations for concurrency, inspired by \citeauthor{YangPWBS22}'s~[\citeyear{YangPWBS22}] \emph{resumption monad}~\citep{Claessen99,Schmidt1986denotational,PirogG14} defined using scoped effects.
We summarize our encoding and compare it with the resumption monad. The goal is to define the two operations, whose higher-order effect signature is given in \cref{fig:concurrency-ho-sig}, and summarized by these smart constructors:
%
%Our goal is to define two higher-order operations:
%
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{postulate}\<%
\end{code}
\begin{code}%
\>[4][@{}l@{\AgdaIndent{1}}]%
\>[6]\AgdaPostulate{‚Äµspawn‚Öã}%
\>[16]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSymbol{)}%
\>[57]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaPostulate{‚Äµatomic‚Öã}%
\>[16]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}%
\>[57]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
%
The operation \af{‚Äµspawn}~\ab{m‚ÇÅ}~\ab{m‚ÇÇ} spawns two threads that run concurrently, and returns the value produced by \ab{m‚ÇÅ} after both have finished.
The operation \af{‚Äµatomic}~\ab{m} represents a block to be executed atomically; i.e., no other threads run before the block finishes executing.

We elaborate \ad{‚Äµspawn} by interleaving the sub-trees of its computations.
To this end, we use a dedicated function which interleaves the operations in two trees and yields as output the value of the left input tree (the first computation parameter):
%
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{CCModule}\<%
\\
%
\>[4]\AgdaKeyword{postulate}\<%
\end{code}
\begin{code}%
\>[4][@{}l@{\AgdaIndent{1}}]%
\>[6]\AgdaPostulate{interleave‚Çó‚Öã}%
\>[20]\AgdaSymbol{:}%
\>[23]\AgdaSymbol{\{}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{B}\<%
\\
%
\>[20]\AgdaSymbol{‚Üí}%
\>[23]\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\end{code}
%
\begin{code}[hide]%
%
\>[2]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{ResumptionModule}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{CCModule}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
\>[0][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaComment{--\ interleaving\ interleaves\ two\ trees,\ except\ for\ sub-scopes\ of\ atomic\ blocks}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaFunction{interleave‚Çó}%
\>[2570I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaComment{\{-‚¶É\ w\ :\ Œî\ ‚àº\ Choice\ ‚ñ∏\ Œî‚Ä≤\ ‚¶Ñ-\}}\<%
\\
\>[.][@{}l@{}]\<[2570I]%
\>[18]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{B}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaGeneralizable{A}\<%
\\
%
\>[6]\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{})}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[6]\AgdaCatchallClause{\AgdaFunction{interleave‚Çó}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{pure}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{x}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m‚ÇÇ}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{fmap}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\<%
\\
%
\>[6]\AgdaCatchallClause{\AgdaFunction{interleave‚Çó}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m‚ÇÅ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{pure}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{x}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\<%
\\
%
\>[6]\AgdaCatchallClause{\AgdaFunction{interleave‚Çó}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{impure}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{inj‚ÇÅ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{jump}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{ref}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{x}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{\AgdaUnderscore{}))}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m‚ÇÇ}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaBound{m‚ÇÇ}\<%
\\
%
\>[8]\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[6]\AgdaCatchallClause{\AgdaFunction{interleave‚Çó}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{m‚ÇÅ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{impure}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{inj‚ÇÅ}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{(}}\AgdaCatchallClause{\AgdaInductiveConstructor{jump}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{ref}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaBound{x}}\AgdaCatchallClause{\AgdaSymbol{)}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaOperator{\AgdaInductiveConstructor{,}}}\AgdaSpace{}%
\AgdaCatchallClause{\AgdaSymbol{\AgdaUnderscore{}))}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaBound{m‚ÇÅ}\<%
\\
%
\>[8]\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
%
\>[6]\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{impure}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[10]\AgdaSymbol{(Œª\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaSymbol{;}%
\>[2679I]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[2679I]%
\>[14]\AgdaInductiveConstructor{impure}\<%
\\
\>[14][@{}l@{\AgdaIndent{0}}]%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[16]\AgdaSymbol{(Œª\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\<%
\\
\>[16][@{}l@{\AgdaIndent{0}}]%
\>[18]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{\}))}\AgdaSpace{}%
\AgdaSymbol{\}))}\<%
\\
%
\>[6]\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaKeyword{do}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{impure}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[10]\AgdaSymbol{(Œª\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaSymbol{;}%
\>[2729I]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[.][@{}l@{}]\<[2729I]%
\>[14]\AgdaInductiveConstructor{impure}\<%
\\
\>[14][@{}l@{\AgdaIndent{0}}]%
\>[16]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[16]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{z}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaSymbol{\}))}\<%
\\
%
\>[6]\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{impure}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[10]\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{x}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaInductiveConstructor{impure}\<%
\\
\>[12][@{}l@{\AgdaIndent{0}}]%
\>[14]\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaInductiveConstructor{sub}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\<%
\\
%
\>[14]\AgdaSymbol{(Œª\{}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{y}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\<%
\\
\>[14][@{}l@{\AgdaIndent{0}}]%
\>[16]\AgdaSymbol{;}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{z}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{\}))))}\<%
\\
%
\>[6]\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÅ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k‚ÇÇ}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{inj‚ÇÇ}\AgdaSpace{}%
\AgdaBound{op‚ÇÇ}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÅ}\AgdaSpace{}%
\AgdaBound{x‚ÇÅ}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{k‚ÇÇ}\AgdaSpace{}%
\AgdaBound{x‚ÇÇ}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaComment{--\ higher-order\ operation\ for\ concurrency\ that\ desugars\ into\ interleaving\ and\ atomic}\<%
\end{code}
\begin{figure}[t]
\begin{minipage}{0.545\linewidth}
\begin{code}%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ConcurOp}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{spawn}%
\>[16]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{ConcurOp}\<%
\\
%
\>[8]\AgdaInductiveConstructor{atomic}%
\>[16]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{ConcurOp}\<%
\end{code}
\end{minipage}
\hfill\vline\hfill
\begin{minipage}{0.445\linewidth}
\begin{code}%
%
\>[6]\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaRecord{Effect·¥¥}\<%
\\
%
\>[6]\AgdaField{Op·¥¥}\AgdaSpace{}%
\AgdaFunction{Concur}%
\>[20]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{ConcurOp}\<%
\\
%
\>[6]\AgdaField{Ret·¥¥}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaField{Ret·¥¥}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}%
\>[32]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
\>[0]\<%
\\
%
\>[6]\AgdaField{Fork}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Bool}\<%
\\
%
\>[6]\AgdaField{Fork}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{)}%
\>[31]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[6]\AgdaField{Ty}%
\>[11]\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[6]\AgdaField{Ty}%
\>[11]\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\end{code}
\end{minipage}
\caption{Higher-order effect signature of the concur effect}
\label{fig:concur-ho-sig}
\end{figure}
\begin{code}[hide]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{u}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{‚Äµspawn}%
\>[2883I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[.][@{}l@{}]\<[2883I]%
\>[15]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{‚Äµspawn}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaArgument{w}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaInductiveConstructor{impure}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{if\AgdaUnderscore{}then}}\AgdaSpace{}%
\AgdaBound{m‚ÇÅ}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{else}}\AgdaSpace{}%
\AgdaBound{m‚ÇÇ}\AgdaSymbol{)))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaFunction{‚Äµatomic}%
\>[2934I]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSymbol{\}}\<%
\\
\>[2934I][@{}l@{\AgdaIndent{0}}]%
\>[17]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaGeneralizable{H}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\<%
\\
%
\>[8]\AgdaFunction{‚Äµatomic}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaArgument{w}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{t}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaBound{m}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{impure}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaSymbol{(}\AgdaFunction{inj·¥¥}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaArgument{M}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}\}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaSymbol{Œª}\AgdaSpace{}%
\AgdaBound{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{m}\AgdaSymbol{))}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[8]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{\{}\AgdaBound{Ref}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSymbol{\}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaGeneralizable{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaFunction{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚àô}}\AgdaSpace{}%
\AgdaField{proj‚ÇÅ}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaOperator{\AgdaRecord{‚âà}}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[12]\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{.}\AgdaField{proj‚ÇÇ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{eConcur}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[10]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eConcur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}%
\>[41]\AgdaSymbol{=}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaFunction{from-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{true}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
%
\>[10]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eConcur}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}%
\>[42]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Äµsub}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{k}\<%
\end{code}
%
%
Here, the \ad{CC} effect is the sub/jump effect that we also used in \cref{sec:optional-transactional}.
The \af{interleave‚Çó} function ensures atomic execution by only interleaving code that is not wrapped in a \af{‚Äµsub} operation.
We elaborate \ad{Concur} into \ad{CC} as follows, where the \af{to-front} and \af{from-front} functions use the row insertion witness \ab{w‚Çê} to move the \ad{CC} effect to the front of the row and back again:
%
\begin{code}%
%
\>[10]\AgdaFunction{eConcur‚Öã}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaBound{w}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaBound{Ref}\AgdaSpace{}%
\AgdaOperator{\AgdaPostulate{‚â≤‚Öã}}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaFunction{Elaboration}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaBound{Œî}\<%
\\
%
\>[10]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eConcur‚Öã}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{spawn}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}%
\>[42]\AgdaSymbol{=}\<%
\\
\>[10][@{}l@{\AgdaIndent{0}}]%
\>[12]\AgdaFunction{from-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{interleave‚Çó}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{true}\AgdaSymbol{))}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{to-front}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{false}\AgdaSymbol{)))}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaBound{k}\<%
\\
%
\>[10]\AgdaField{alg}\AgdaSpace{}%
\AgdaFunction{eConcur‚Öã}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaInductiveConstructor{atomic}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{k}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSymbol{)}%
\>[43]\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Äµsub}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaBound{œà}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{ùìë}}\AgdaSpace{}%
\AgdaFunction{‚Äµjump}\AgdaSpace{}%
\AgdaBound{ref}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaBound{k}\<%
\end{code}
%
The elaboration uses \af{‚Äµsub} as a delimiter for blocks that should not be interleaved, such that the \af{interleave‚Çó} function only interleaves code that does not reside in atomic blocks.
At the end of an \ac{atomic} block, we \af{‚Äµjump} to the (possibly interleaved) computation context, \ab{k}.
By using \af{‚Äµsub} to explicitly delimit blocks that should not be interleaved, we have encoded what \citet[\S{}~7]{WuSH14} call \emph{scoped syntax}.

\paragraph*{Example.}
  Below is an example program that spawns two threads that use the \ad{Output} effect.
  The first thread prints \an{0}, \an{1}, and \an{2}; the second prints \an{3} and \an{4}.
%
\begin{code}[hide]%
\>[0][@{}l@{\AgdaIndent{5}}]%
\>[4]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{ConcurExample}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[4][@{}l@{\AgdaIndent{0}}]%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaKeyword{import}\AgdaSpace{}%
\AgdaModule{Data.Nat}\AgdaSpace{}%
\AgdaKeyword{using}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaComment{--\ open\ OutModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{HeftyModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{FreeModule}\AgdaSpace{}%
\AgdaKeyword{hiding}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}ùìë\AgdaUnderscore{}}}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{\AgdaUnderscore{}>>\AgdaUnderscore{}}}\AgdaSymbol{)}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{ElabModule}\<%
\\
%
\>[6]\AgdaKeyword{open}\AgdaSpace{}%
\AgdaModule{CCModule}\<%
\\
%
\>[6]\AgdaComment{--\ open\ Elab}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{ConcurType}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaInductiveConstructor{unit}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ConcurType}\<%
\\
%
\>[8]\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{ConcurType}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{instance}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaFunction{ConcurUniv}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaRecord{Univ}\<%
\\
%
\>[8]\AgdaField{Type}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{ConcurUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{ConcurType}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{ConcurUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{unit}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaRecord{‚ä§}\<%
\\
%
\>[8]\AgdaOperator{\AgdaField{‚ü¶\AgdaUnderscore{}‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{ConcurUniv}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\AgdaSpace{}%
\AgdaInductiveConstructor{num}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\end{code}
\begin{code}%
%
\>[8]\AgdaFunction{ex-01234}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[8]\AgdaFunction{ex-01234}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Äµspawn}%
\>[27]\AgdaSymbol{(}\AgdaKeyword{do}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"0"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"1"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"2"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}\AgdaKeyword{do}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"3"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"4"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{)}\<%
\end{code}
%
Since the \ad{Concur} effect is elaborated to interleave the effects of the two threads, the printed output appears in interleaved order:
%
\begin{code}[hide]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaField{proj‚ÇÅ}\AgdaSpace{}%
\AgdaFunction{x‚ÇÄ}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{‚àô-refl}\<%
\\
\>[0]\<%
\\
%
\>[8]\AgdaFunction{concur-elab}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[3262I]\AgdaFunction{Elaboration}\<%
\\
\>[3262I][@{}l@{\AgdaIndent{0}}]%
\>[27]\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaSymbol{(}%
\>[30]\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\<%
\\
%
\>[27]\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Output}\<%
\\
%
\>[27]\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSpace{}%
\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{concur-elab}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{eLift}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eConcur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚ãé}}\AgdaSpace{}%
\AgdaFunction{eNil}\<%
\end{code}
\begin{code}%
%
\>[8]\AgdaFunction{test-ex-01234}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[25]\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{(}%
\>[31]\AgdaSymbol{(}%
\>[34]\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hOut}\<%
\\
%
\>[34]\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}%
\>[44]\AgdaSymbol{(}%
\>[47]\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hCC}\<%
\\
%
\>[47]\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{elaborate}\AgdaSpace{}%
\AgdaFunction{concur-elab}\AgdaSpace{}%
\AgdaFunction{ex-01234}\AgdaSymbol{)}\<%
\\
%
\>[44]\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaString{"03142"}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{test-ex-01234}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
%
The following program spawns an additional thread with an \ad{‚Äµatomic} block
%
\begin{code}[hide]%
%
\>[6]\AgdaKeyword{module}\AgdaSpace{}%
\AgdaModule{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[6][@{}l@{\AgdaIndent{0}}]%
\>[8]\AgdaKeyword{private}\AgdaSpace{}%
\AgdaKeyword{instance}\<%
\\
\>[8][@{}l@{\AgdaIndent{0}}]%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤·¥¥}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{x‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤·¥¥-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{y‚ÇÄ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{y‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{CC}\AgdaSpace{}%
\AgdaSymbol{(Œª}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚ü¶}}\AgdaSpace{}%
\AgdaBound{t}\AgdaSpace{}%
\AgdaOperator{\AgdaField{‚üß·µÄ}}\AgdaSpace{}%
\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚äï}}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\<%
\\
%
\>[10]\AgdaFunction{y‚ÇÅ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚â≤-right}\AgdaSpace{}%
\AgdaSymbol{‚¶É}\AgdaSpace{}%
\AgdaFunction{‚â≤-left}\AgdaSpace{}%
\AgdaSymbol{‚¶Ñ}\<%
\\
%
\\[\AgdaEmptyExtraSkip]%
%
\>[10]\AgdaFunction{y‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚â≤}}\AgdaSpace{}%
\AgdaField{proj‚ÇÅ}\AgdaSpace{}%
\AgdaFunction{y‚ÇÄ}\<%
\\
%
\>[10]\AgdaFunction{y‚ÇÇ}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaSymbol{\AgdaUnderscore{}}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaFunction{‚àô-refl}\<%
\end{code}
\begin{code}%
%
\>[8]\AgdaFunction{ex-01234567}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Hefty}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Output}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Concur}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚àî}}\AgdaSpace{}%
\AgdaFunction{Lift}\AgdaSpace{}%
\AgdaFunction{Nil}\AgdaSymbol{)}\AgdaSpace{}%
\AgdaDatatype{‚Ñï}\<%
\\
%
\>[8]\AgdaFunction{ex-01234567}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaFunction{‚Äµspawn}%
\>[30]\AgdaFunction{ex-01234}\<%
\\
%
\>[30]\AgdaSymbol{(}\AgdaFunction{‚Äµatomic}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaKeyword{do}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"5"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"6"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaOperator{\AgdaFunction{‚Üë}}\AgdaSpace{}%
\AgdaInductiveConstructor{out}\AgdaSpace{}%
\AgdaString{"7"}\AgdaSymbol{;}\AgdaSpace{}%
\AgdaInductiveConstructor{pure}\AgdaSpace{}%
\AgdaNumber{0}\AgdaSymbol{))}\<%
\end{code}
%
Inspecting the output, we see that the additional thread indeed computes atomically:
%
\begin{code}%
%
\>[8]\AgdaFunction{test-ex-01234567}\AgdaSpace{}%
\AgdaSymbol{:}%
\>[28]\AgdaFunction{un}\AgdaSpace{}%
\AgdaSymbol{(}%
\>[34]\AgdaSymbol{(}%
\>[37]\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hOut}\<%
\\
%
\>[37]\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}%
\>[47]\AgdaSymbol{(}%
\>[50]\AgdaOperator{\AgdaFunction{given}}\AgdaSpace{}%
\AgdaFunction{hCC}\<%
\\
%
\>[50]\AgdaOperator{\AgdaFunction{handle}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaFunction{elaborate}\AgdaSpace{}%
\AgdaFunction{concur-elab}\AgdaSpace{}%
\AgdaFunction{ex-01234567}\AgdaSymbol{)}\<%
\\
%
\>[47]\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaInductiveConstructor{tt}\AgdaSpace{}%
\AgdaSymbol{)}\AgdaSpace{}%
\AgdaOperator{\AgdaDatatype{‚â°}}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaNumber{0}\AgdaSpace{}%
\AgdaOperator{\AgdaInductiveConstructor{,}}\AgdaSpace{}%
\AgdaString{"05673142"}\AgdaSymbol{)}\<%
\\
%
\>[8]\AgdaFunction{test-ex-01234567}\AgdaSpace{}%
\AgdaSymbol{=}\AgdaSpace{}%
\AgdaInductiveConstructor{refl}\<%
\end{code}
%
\begin{code}[hide]%
\>[0]\AgdaComment{--\ \ \ \ \ \ \ concur-elab‚Ä≤\ :\ Elaboration}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (Lift\ Output\ ‚àî\ Concur\ ‚àî\ Lift\ Nil)}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ (\ \ Output}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ‚äï\ CC\ (Œª\ t\ ‚Üí\ ‚ü¶\ t\ ‚üß·µÄ\ ‚Üí\ Free\ Nil\ (‚Ñï\ √ó\ String))}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ ‚äï\ Nil\ )}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ concur-elab‚Ä≤\ =\ eLift\ ‚ãé\ eConcur\ ‚ãé\ eNil}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-ex‚Ä≤\ :\ un\ (\ \ (\ \ given\ hCC}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (\ \ (\ \ given\ hOut}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ handle\ (elaborate\ concur-elab‚Ä≤\ ex-01234)\ )}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ \ tt\ )\ )\ tt\ )\ ‚â°\ (0\ ,\ "03142")}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-ex‚Ä≤\ =\ refl}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-atomic-01234\ :\ Hefty\ (Lift\ Output\ ‚àî\ Concur\ ‚àî\ Lift\ Nil)\ ‚Ñï}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ ex-atomic-01234\ =\ ‚Äµspawn\ (‚Äµatomic\ (do\ ‚Üë\ out\ "0";\ ‚Üë\ out\ "1";\ ‚Üë\ out\ "2";\ pure\ 0))\ (do\ ‚Üë\ out\ "3";\ ‚Üë\ out\ "4";\ pure\ 0)}\<%
\\
\>[0]\AgdaComment{--\ }\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ --\ ordering\ of\ handlers\ matters!}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-atomic-ex\ :\ un\ ((given\ hCC\ handle\ ((given\ hOut\ handle\ (elaborate\ concur-elab‚Ä≤\ ex-atomic-01234))\ tt))\ tt)\ ‚â°\ (0\ ,\ "34")}\<%
\\
\>[0]\AgdaComment{--\ \ \ \ \ \ \ test-atomic-ex\ =\ refl}\<%
\end{code}

The example above is inspired by the resumption monad, and in particular by the scoped effects definition of concurrency due to \citet{YangPWBS22}.
\citeauthor{YangPWBS22} do not (explicitly) consider how to define the concurrency operations in a modular style.
Instead, they give a direct semantics that translates to the resumption monad which we can encode as follows in Agda (assuming resumptions are given by the free monad):
%
\begin{code}%
\>[0][@{}l@{\AgdaIndent{1}}]%
\>[2]\AgdaKeyword{data}\AgdaSpace{}%
\AgdaDatatype{Resumption}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\AgdaSpace{}%
\AgdaSymbol{:}\AgdaSpace{}%
\AgdaPrimitive{Set}\AgdaSpace{}%
\AgdaKeyword{where}\<%
\\
\>[2][@{}l@{\AgdaIndent{0}}]%
\>[4]\AgdaInductiveConstructor{done}%
\>[10]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaBound{A}%
\>[37]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Resumption}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\<%
\\
%
\>[4]\AgdaInductiveConstructor{more}%
\>[10]\AgdaSymbol{:}\AgdaSpace{}%
\AgdaDatatype{Free}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaSymbol{(}\AgdaDatatype{Resumption}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\AgdaSymbol{)}%
\>[37]\AgdaSymbol{‚Üí}\AgdaSpace{}%
\AgdaDatatype{Resumption}\AgdaSpace{}%
\AgdaBound{Œî}\AgdaSpace{}%
\AgdaBound{A}\<%
\end{code}
%
We could elaborate into this type using a hefty algebra \ad{Alg·¥¥}~\ad{Concur}~\as{(}\ad{Resumption}~\ab{Œî}\as{)} but that would be incompatible with our other elaborations which use the free monad.
For that reason, we emulate the resumption monad using the free monad instead of using the \ad{Resumption} type directly.


%%% Local Variables:
%%% reftex-default-bibliography: ("../references.bib")
%%% End:

